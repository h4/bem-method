# Методология сборки БЭМ-проекта

Организация файловой системы, обусловленная использованием компонентного подхода, определяет особенности сборки БЭМ-проекта.

Сборка решает следующие задачи:
* собирает отдельные [файлы реализаций](../filesystem/filesystem.ru.md#Реализация-блока-разделяется-на-отдельные-файлы), разложенные по файловой системе;
* включает в сборку только нужные блоки и элементы из имеющихся в проекте;
* учитывает порядок подключения файлов в сборку.

Рассмотрим организацию файловой структуры типового БЭМ-проекта.

БЭМ-методология предполагает разделение интерфейса на независимые [блоки](../definitions/definitions.ru.md#Блок). Блоки, в свою очередь, могут быть реализованы в одной или нескольких [технологиях](../definitions/definitions.ru.md#Технология-реализации). Технологии реализации находятся в отдельных файлах. [Реализация](../definitions/definitions.ru.md#Реализация-блока) каждого блока может быть дополнительно разделена по [уровням переопределения](../definitions/definitions.ru.md#Уровень-переопределения).

```
blocks/                 # Уровень проекта
    input/              # Директория блока `input`
        input.css       # Реализация блока `input` в технологии CSS
        input.js        # Реализация блока `input` в технологии JavaScript
    icon/
        icon.css
library/                # Уровень библиотеки
    input/
    button/
```

>Подробно о целях разделения блоков на отдельные файлы читайте в документе [Организация файловой системы БЭМ-проекта](../filesystem/filesystem.ru.md).

## Основные этапы сборки

Чтобы из множества директорий и файлов получить рабочую страницу (результат сборки), необходимо выполнить следующие этапы сборки:

* [определить блоки и элементы, необходимые для построения страницы](#Определение-необходимых-блоков-и-элементов-для-создания-страницы);
* [раскрыть зависимости используемых БЭМ-сущностей](#Раскрытие-зависимостей-используемых-БЭМ-сущностей);
* [подключить БЭМ-сущности в сборку в порядке, определенном в конфигурационном файле сборщика](#Определение-порядка-подключения-БЭМ-сущностей-в-сборку).

<a name="bundle"></a>
БЭМ-методология позволяет собрать как сайт целиком, так и отдельную страницу (или даже фрагмент страницы). Результат сборки в БЭМ-проектах принято называть **бандлом**. Так, бандлом может быть страница, проект целиком или общая часть для разных страниц (например, `шапка` (`head`) и `подвал` (`footer`) могут быть собраны один раз для всех страниц проекта).

> В этом документе сборка рассматривается на примере частного случая бандла — страницы.

В файловой системе результат сборки страницы (бандла) помещается в отдельную директорию с названием этой страницы (например, `hello-page`) в общую директорию `bundles`, которая находится в корне проекта:

```
blocks/                # Директория, содержащая блоки
bundles/               # Директория, содержащая все результаты сборки
    hello-page/        # Директория страницы `hello-page`
```

Пример файловой системы БЭМ-проекта до выполнения сборки:

```
blocks/         # Директория, содержащая блоки
bundles/        # Директория, содержащая все результаты сборки
    hello-page/   # Директория страницы `hello-page`
        hello-page.bemjson.js  # Описание страницы `hello-page` в формате BEMJSON
```

Пример файловой системы БЭМ-проекта после выполнения сборки:

```
blocks/         # Директория, содержащая блоки
bundles/        # Директория, содержащая все результаты сборки
    hello-page/   # Директория страницы `hello-page`
        hello-page.bemjson.js  # Описание страницы `hello-page` в формате BEMJSON
        hello-page.html     # Собранный HTML-файл страницы `hello-page`
        hello-page.css      # Собранный CSS-файл страницы `hello-page`
        hello-page.js       # Собранный JavaScript-файл страницы `hello-page`
```

Для того, чтобы в результат сборки попали только нужные БЭМ-сущности в строго определенном порядке, при сборке БЭМ-проекта используются:

* [Декларация](#decl)
* [Зависимости](#deps)
* [Уровни переопределения](#levels)

Применение зависимостей, уровней переопределения и декларации при сборке опционально. В таком случае в проект будут собраны все БЭМ-сущности с файловой системы, что значительно увеличит кодовую базу собранного проекта.

### Определение необходимых блоков и элементов для создания страницы

Чтобы начать сборку страницы, необходимо узнать, из каких компонентов она состоит. В большинстве проектов, построенных не по БЭМ, структура страницы описывается с помощью HTML. В БЭМ-проекте все БЭМ-сущности, необходимые для построения страницы описываются в декларации. Существуют различные способы построения декларации, подробнее о них читайте в разделе [Способы получения декларации](#Способы-получения-декларации)

<a name="decl"></a>
**Декларация** — упорядоченное множество БЭМ-сущностей, необходимых для сборки страницы. В декларации не отображается вложенность и дублирование. Основная задача декларации определить, что и в каком порядке подключать в сборку.

![Декларация](https://img-fotki.yandex.ru/get/15577/246231603.1/0_16353e_4f60f18f_orig)

Рассмотрим пример использования декларации:

В проект подключена библиотека, из которой на странице используются несколько блоков. Нет необходимости включать все блоки библиотеки в сборку страницы. Достаточно по описанию страницы построить декларацию, которая будет содержать нужный набор блоков. На основании декларации в сборку попадут только перечисленные блоки.

Файл декларации находится в директории страницы:

```
blocks/
    input/
    button/
    checkbox/
bundles/
    hello-page/
        hello-page.bemjson.js  # Описание страницы `hello-page` в формате BEMJSON
        hello-page.bemdecl.js # Упорядоченное множество БЭМ-сущностей для сборки страницы `hello-page`
```

>В БЭМ-платформе описание страницы создается формате BEMJSON, а декларация страницы описывается в формате BEMDECL, например:
```js
exports.blocks = [
    { name: 'input' },
    { name: 'button' },
    { name: 'checkbox' }
];
```

#### Способы получения декларации

Декларация может формироваться вручную (для этого нужно перечислить БЭМ-сущности, необходимые для построения страницы) или строиться автоматически:

* [по описанию страницы](#Создание-декларации-по-описанию-страницы)
* [с помощью интроспекции файловой системы](#Создание-декларации-с-помощью-интроспекции-файловой-системы)

##### Создание декларации по описанию страницы

В БЭМ-методологии структура страницы описывается в терминах блоков, элементов и модификаторов с помощью [БЭМ-дерева](../definitions/definitions.ru.md#БЭМ-дерево). БЭМ-дерево содержит имена [БЭМ-сущностей](../definitions/definitions.ru.md#БЭМ-сущность), которые используются на странице, описывает их порядок и вложенность. БЭМ-дерево может быть создано вручную (BEMJSON) или построено автоматически, например, на основании HTML-файла.

При сборке страницы декларация формируется автоматически на основании данных из БЭМ-дерева: все сущности, используемые в БЭМ-дереве, попадают в декларацию в требуемом порядке, без повторений и отображения вложенности.

Один из инструментов, позволяющих получить БЭМ-дерево из HTML-структуры страницы — [html2bemjson](https://github.com/bem-incubator/html2bemjson).

![Способ создания декларации](https://img-fotki.yandex.ru/get/6114/246231603.1/0_162b0c_f5211dc6_orig)

Пример показывает, как в результате анализа HTML-классов, написанных в соответствии с [соглашением по именованию БЭМ](../naming/naming-convention.ru.md), создается декларация.

>Пример проекта, в котором формируется отдельная декларация для каждой страницы — [Создаем свой проект на БЭМ](https://ru.bem.info/tutorials/start-with-project-stub/).

##### Создание декларации с помощью интроспекции файловой системы

При сборке в декларацию автоматически попадают все БЭМ-сущности, находящиеся в файловой системе проекта на уровнях переопределения, указанных в конфигурационном файле сборки.

![Способ создания декларации](https://img-fotki.yandex.ru/get/4510/246231603.1/0_162b0d_d4139277_orig)

>В [bem-components](https://ru.bem.info/libs/bem-components/) такой способ создания декларации используется для поставки библиотеки в виде [Dist](https://ru.bem.info/libs/bem-components/current/#Варианты-поставки-библиотеки).

#### Способы управления декларациями

БЭМ-методология позволяет управлять сборкой с помощью различных действий над декларациями. Декларации можно совмещать, повторно использовать, выделять общие части или различия. Такое управление декларациями дает возможность собирать все страницы в один [бандл](#bundle), догружать необходимые части страницы по требованию, повторно использовать уже собранные общие компоненты на разных страницах и не только.

Рассмотрим возможные действия с декларациями:

* [сложение](#Объединение-нескольких-деклараций-в-одну) — объединение нескольких деклараций в одну;
* [вычитание](#Получение-разницы-между-декларациями) — получение разницы между декларациями;
* [пересечение](#Получение-новой-декларации-на-основе-пересечения-нескольких-других) — получение новой декларации на основе пересечения нескольких других.

##### Объединение нескольких деклараций в одну

Применяется для создания общих файлов технологий (например, один CSS- и JavaScript-файл) для нескольких страниц. Объединяет все БЭМ-сущности суммируемых деклараций в одну. Один из способов применения — формирование [merged-бандла](https://github.com/enb-bem/enb-bem-techs/blob/master/docs/build-merged-bundle.md). В результате для объединенной декларации генерируются общие файлы технологий.

##### Получение разницы между декларациями

Один из способов применения — сборка части страницы, которая догружается по требованию (например, в ответ на действие пользователя).

Например, на странице используется виртуальная клавиатура, которая становится доступна пользователю только в ответ на определенное действие. Нет необходимости включать этот блок в сборку всей страницы, так как это увеличит время при загрузке. Частично кнопки клавиатуры могут быть уже реализованы на странице для других целей. Возможность вычитать декларации позволяет создать отдельный бандл (часть страницы) для недостающей реализации виртуальной клавиатуры и подключать его только по требованию.

##### Получение новой декларации на основе пересечения нескольких других

Применяется для создания декларации, описывающей общие части разных страниц проекта. Это позволяет собрать общую часть для всех страниц и подключать его при сборке один раз ко всем страницам.

Например, такое разделение эффективно, если в проекте на всех страницах используется `шапка` и `подвал`. Общая часть страниц описывается в отдельной декларации. При сборке каждая страница формируется на основании двух деклараций: общей (содержащей `шапку` и `подвал`) и уникальной.

<a name="deps"></a>
### Раскрытие зависимостей используемых БЭМ-сущностей

Согласно БЭМ-методологии все блоки создаются независимыми. Это дает [ряд преимуществ](https://ru.bem.info/method/solved-problems/#Как-начать-повторно-использовать-код-и-избежать-взаимного-влияния-компонентов-друг-на-друга) во время разработки. Но на странице блоки должны взаимодействовать друг с другом. Для обеспечения связи между блоками и их корректной работы необходимо указать зависимости.

Существует несколько способов указать зависимости:

* В файлах реализации блока.<br>

  ```
  blocks/
      input/
          input.css       # Зависимости в CSS можно определять по правилам `@import`.
          input.js        # Зависимости в JavaScript можно декларировать с помощью модульной системы.
      button/
          button.css
          button.js
  ```

* В отдельном файле блока.

  >В БЭМ-платформе для указания зависимостей используется технология [DEPS](https://ru.bem.info/technology/deps/).

  ```
  blocks/
      input/
          input.css
          input.js
          input.deps.js   # Файл с зависимостями блока `input`.
      button/
          button.css
          button.js
  ```

На основе информации о зависимостях инструмент сборки определяет, какие дополнительные сущности или технологии необходимы для реализации блока, и включает их при сборке в требуемом порядке.

<a name="levels"></a>
### Определение порядка подключения БЭМ-сущностей в сборку

Когда все БЭМ-сущности найдены, зависимости установлены, важно соблюдать порядок подключения всех файлов в сборку. Порядок подключения определяется в конфигурационном файле сборщика.

Почему так важно соблюдать порядок?

В БЭМ-методологии существует понятие [уровня переопределения](../definitions/definitions.ru.md#Уровень-переопределения). С помощью уровней можно изменять исходные реализации БЭМ-сущностей. Для того, чтобы [переопределние](../definitions/definitions.ru.md#Переопределение-блока) прошло корректно необходимо последовательно собирать реализацию блока с требуемых уровней.

Если сравнить уровни со слоями, то базовый слой – это исходная реализация блока, а каждый последующий слой накладывается сверху и дополняет или изменяет базовую реализацию. Поэтому важно, чтобы в сборку сначала попадала исходная реализация блока, а затем изменения со всех уровней переопределения.

На схеме показан принцип использования уровней переопределения при сборке: с уровня `common` подключаются общие компоненты для всех платформ, а с уровней `desktop` и `touch` — платформо-специфичные компоненты.

![Уровни переопределения](https://img-fotki.yandex.ru/get/15587/246231603.1/0_162b0f_98525a17_orig)

Подробно об использовании уровней читайте в примерах:

* [Переопределение блоков библиотеки](../filesystem/filesystem.ru.md#Подключение-библиотеки).
* [Разделение проекта на платформы](../filesystem/filesystem.ru.md#Разделение-проекта-на-платформы).

## Инструменты для сборки

Выбор инструмента для сборки зависит от сложности БЭМ-проекта, наличия в нем уровней переопределения и использования зависимостей.

БЭМ-методология не ограничивает выбор инструмента — можно использовать любые сборщики (например, Gulp, Grunt, Brunch, Broccoli), отвечающие требованиям вашего проекта.

>Пример сборки БЭМ-проекта с помощью Gulp — [Декларативный JavaScript по БЭМ](https://ru.bem.info/events/beminar-july-2015/).

В БЭМ-платформе реализованы два инструмента, которые подходят для сборки БЭМ-проектов любой сложности:

* [ENB](https://ru.bem.info/tools/bem/enb-bem/)
* [bem-tools](https://ru.bem.info/tools/bem/bem-tools/)

>Пример сборки БЭМ-проекта с помощью [ENB](https://ru.bem.info/tools/bem/enb-bem/) или [bem-tools](https://ru.bem.info/tools/bem/bem-tools/) — [Создаем свой проект на БЭМ](https://ru.bem.info/tutorials/start-with-project-stub/).

